# 版本发布标准操作手册

## 📋 重要提醒

**⚠️ 关键要点**: 每个版本发布必须完成以下4个步骤，缺一不可！
1. 版本准备
2. Git操作  
3. GitHub Release创建
4. **更新服务器配置** ← **最容易遗漏的步骤**

## 🎯 发布前准备

### 确认信息
- [ ] 新版本号（如：v1.0.2）
- [ ] 版本类型（major/minor/patch）
- [ ] 更新内容描述
- [ ] 功能特性列表

### 环境检查
- [ ] 开发环境正常
- [ ] 网络连接正常
- [ ] Git仓库状态干净
- [ ] 管理员令牌可用：`chengshang-admin-token-2025-secure-update-server-key`

## 🚀 标准发布流程

### 第一步：版本准备 ✅

#### 1.1 更新版本数据
编辑 `lib/version-data.ts`，在数组开头添加新版本：

```typescript
{
  version: "1.0.2",  // 新版本号
  date: "2025-07-30", // 发布日期
  type: "minor",      // 版本类型
  title: "🎯 新功能标题",
  description: "详细描述...",
  features: [
    { icon: "sparkles", text: "新功能1", highlight: true },
    { icon: "zap", text: "新功能2" },
    // ... 更多功能
  ],
  isNew: true,
  downloadUrl: "https://github.com/XUXIKAI886/zhuomianhejizidonggengx/releases/tag/v1.0.2"
},
```

#### 1.2 更新Tauri版本号
编辑 `src-tauri/tauri.conf.json`：

```json
{
  "productName": "csch",  // 使用英文名称，避免中文字符被GitHub过滤
  "version": "1.0.3"      // 更新版本号
}
```

**⚠️ 重要**: `productName` 必须使用英文，因为GitHub Release会过滤中文字符，导致安装包文件名不完整。

#### 1.3 构建应用
```bash
npm run tauri:build
```

**验证**: 确认生成文件 `src-tauri/target/release/bundle/nsis/csch_1.0.3_x64-setup.exe`

### 第二步：Git操作 ✅

#### 2.1 提交代码
```bash
git add .
git commit -m "feat: 发布版本 v1.0.2 - 新功能描述"
```

#### 2.2 创建标签
```bash
git tag v1.0.2
```

#### 2.3 推送到远程
```bash
git push origin master
git push origin v1.0.2
```

**验证**: 确认GitHub仓库中出现新的标签

### 第三步：GitHub Release创建 ✅

#### 3.1 访问GitHub
打开：https://github.com/XUXIKAI886/zhuomianhejizidonggengx/releases

#### 3.2 创建新Release
1. 点击 **"Create a new release"**
2. 选择标签：`v1.0.2`
3. 填写标题：`呈尚策划工具箱 v1.0.2 - 新功能标题`
4. 填写描述：
```markdown
## 🎯 新功能标题

### ✨ 主要功能
- 新功能1的详细说明
- 新功能2的详细说明
- 新功能3的详细说明

### 📦 安装说明
1. 下载 `呈尚策划项目展示_1.0.2_x64-setup.exe`
2. 运行安装程序
3. 应用将自动检查更新

### 🔧 技术改进
- 性能优化
- 界面改进
- Bug修复
```

#### 3.3 上传安装包
将 `src-tauri/target/release/bundle/nsis/csch_1.0.3_x64-setup.exe` 拖拽到附件区域

**⚠️ 重要**: 使用英文文件名可以避免GitHub Release中文字符被过滤的问题

#### 3.4 发布Release
点击 **"Publish release"**

**验证**: 确认Release页面显示新版本，安装包可以下载

### 第四步：更新服务器配置 ⚠️ **关键步骤**

#### 4.1 执行配置命令
**重要**: 必须将以下命令中的版本号、描述、URL替换为实际值

```bash
curl -X POST "https://zhuomianhejizidonggengx.vercel.app/api/releases" \
  -H "Authorization: Bearer chengshang-admin-token-2025-secure-update-server-key" \
  -H "Content-Type: application/json" \
  -d '{
    "target": "windows-x86_64",
    "version": "1.0.2",
    "notes": "🎯 新功能标题\n\n✨ 主要功能：\n• 新功能1的详细说明\n• 新功能2的详细说明\n• 新功能3的详细说明\n• 性能优化和界面改进\n• Bug修复和稳定性提升",
    "signature": "dW50cnVzdGVkIGNvbW1lbnQ6IHJzdCBzaWduaW5nIGNyeXB0b2dyYXBoaWNhbGx5IHNlY3VyZSBzaWduYXR1cmVzIGFyZSBhdmFpbGFibGUgZm9yIGluc3RhbGxpbmdcblJXU0JBSG9yOEJlSkcxZ3pPdmJTZ2VoZTE2amQ2",
    "url": "https://github.com/XUXIKAI886/zhuomianhejizidonggengx/releases/download/v1.0.3/csch_1.0.3_x64-setup.exe"
  }'
```

#### 4.2 成功响应
- **成功**: 无错误信息或空响应
- **已存在**: `{"error":"版本已存在","message":"版本 1.0.2 已经存在于 windows-x86_64 平台"}` （这也是成功）
- **失败**: 其他错误信息

## 🧪 发布验证

### 验证更新检查
测试旧版本是否能检测到新版本：

```bash
curl "https://zhuomianhejizidonggengx.vercel.app/api/releases/windows-x86_64/1.0.1"
```

**期望结果**: 返回新版本信息
```json
{
  "version": "1.0.2",
  "notes": "更新说明...",
  "pub_date": "2025-07-30T...",
  "platforms": {
    "windows-x86_64": {
      "signature": "...",
      "url": "https://github.com/.../v1.0.2/..."
    }
  }
}
```

### 验证当前版本
测试新版本是否返回无更新：

```bash
curl "https://zhuomianhejizidonggengx.vercel.app/api/releases/windows-x86_64/1.0.2"
```

**期望结果**: 返回空平台信息
```json
{
  "version": "1.0.2",
  "notes": "",
  "pub_date": null,
  "platforms": {}
}
```

### 验证服务器状态
```bash
curl "https://zhuomianhejizidonggengx.vercel.app/health"
```

**期望结果**: 服务器正常运行

## ❌ 常见错误与解决

### 错误1: 权限不足
**现象**: `401 Unauthorized`
**解决**: 检查管理员令牌是否正确

### 错误2: 版本已存在
**现象**: `{"error":"版本已存在"}`
**解决**: 这是正常的，说明版本已配置

### 错误3: 网络连接失败
**现象**: `curl: (7) Failed to connect`
**解决**: 检查网络连接和服务器状态

### 错误4: JSON格式错误
**现象**: `400 Bad Request`
**解决**: 检查JSON格式，特别是引号和转义字符

## 📝 发布检查清单

### 发布前检查
- [ ] 版本号已更新（tauri.conf.json）
- [ ] 版本数据已添加（version-data.ts）
- [ ] 应用构建成功
- [ ] Git状态干净

### 发布过程检查
- [ ] 代码已提交
- [ ] 标签已创建并推送
- [ ] GitHub Release已创建
- [ ] 安装包已上传
- [ ] **更新服务器已配置** ← **重点检查**

### 发布后验证
- [ ] 旧版本能检测到更新
- [ ] 新版本返回无更新
- [ ] 下载链接可访问
- [ ] 版本通知显示正确

## 🎯 版本号规范

### 语义化版本
- **Major (x.0.0)**: 重大功能变更，可能不兼容
- **Minor (x.y.0)**: 新增功能，向下兼容
- **Patch (x.y.z)**: Bug修复，向下兼容

### 示例
- `1.0.0` → `1.0.1`: 修复更新
- `1.0.1` → `1.1.0`: 功能更新  
- `1.1.0` → `2.0.0`: 重大更新

## 🔗 相关链接

- **GitHub仓库**: https://github.com/XUXIKAI886/zhuomianhejizidonggengx
- **更新服务器**: https://zhuomianhejizidonggengx.vercel.app
- **Release页面**: https://github.com/XUXIKAI886/zhuomianhejizidonggengx/releases
- **服务器状态**: https://zhuomianhejizidonggengx.vercel.app/health

## ⚠️ 重要提醒

1. **每个步骤都必须完成**，特别是第4步更新服务器配置
2. **版本号必须一致**，在所有文件和命令中
3. **URL必须正确**，指向实际的GitHub Release下载地址
4. **测试验证**，确保更新系统正常工作
5. **保存记录**，记录每次发布的详细信息

## 📚 附录：实际操作示例

### 示例：发布v1.0.3版本

假设要发布一个新的功能更新版本v1.0.3，包含"智能搜索功能"：

#### 第一步：版本准备
```bash
# 1. 编辑 lib/version-data.ts，在数组开头添加：
{
  version: "1.0.3",
  date: "2025-07-30",
  type: "minor",
  title: "🔍 智能搜索功能上线",
  description: "新增强大的智能搜索功能，支持模糊匹配和快速定位。",
  features: [
    { icon: "sparkles", text: "全新智能搜索引擎", highlight: true },
    { icon: "zap", text: "支持模糊匹配和拼音搜索" },
    { icon: "settings", text: "可自定义搜索范围和过滤条件" }
  ],
  isNew: true,
  downloadUrl: "https://github.com/XUXIKAI886/zhuomianhejizidonggengx/releases/tag/v1.0.3"
}

# 2. 编辑 src-tauri/tauri.conf.json：
"version": "1.0.3"

# 3. 构建应用：
npm run tauri:build
```

#### 第二步：Git操作
```bash
git add .
git commit -m "feat: 发布版本 v1.0.3 - 智能搜索功能上线"
git tag v1.0.3
git push origin master
git push origin v1.0.3
```

#### 第三步：GitHub Release
1. 访问：https://github.com/XUXIKAI886/zhuomianhejizidonggengx/releases
2. 点击"Create a new release"
3. 标签：v1.0.3
4. 标题：呈尚策划工具箱 v1.0.3 - 智能搜索功能
5. 上传：呈尚策划项目展示_1.0.3_x64-setup.exe
6. 发布Release

#### 第四步：更新服务器配置
```bash
curl -X POST "https://zhuomianhejizidonggengx.vercel.app/api/releases" \
  -H "Authorization: Bearer chengshang-admin-token-2025-secure-update-server-key" \
  -H "Content-Type: application/json" \
  -d '{
    "target": "windows-x86_64",
    "version": "1.0.3",
    "notes": "🔍 智能搜索功能上线\n\n✨ 主要功能：\n• 全新智能搜索引擎\n• 支持模糊匹配和拼音搜索\n• 可自定义搜索范围和过滤条件\n• 性能优化和界面改进",
    "signature": "dW50cnVzdGVkIGNvbW1lbnQ6IHJzdCBzaWduaW5nIGNyeXB0b2dyYXBoaWNhbGx5IHNlY3VyZSBzaWduYXR1cmVzIGFyZSBhdmFpbGFibGUgZm9yIGluc3RhbGxpbmdcblJXU0JBSG9yOEJlSkcxZ3pPdmJTZ2VoZTE2amQ2",
    "url": "https://github.com/XUXIKAI886/zhuomianhejizidonggengx/releases/download/v1.0.3/呈尚策划项目展示_1.0.3_x64-setup.exe"
  }'
```

## 🛠️ 故障排除指南

### 问题：构建失败
**症状**: `npm run tauri:build` 报错
**排查步骤**:
1. 检查Node.js和Rust环境
2. 清理缓存：`npm run clean` 或删除 `node_modules`
3. 重新安装依赖：`npm install`
4. 检查代码语法错误

### 问题：Git推送失败
**症状**: `git push` 被拒绝
**排查步骤**:
1. 检查网络连接
2. 验证Git凭据
3. 拉取最新代码：`git pull origin master`
4. 解决冲突后重新推送

### 问题：GitHub Release创建失败
**症状**: 无法创建Release或上传文件
**排查步骤**:
1. 检查GitHub登录状态
2. 验证仓库权限
3. 检查文件大小限制（100MB）
4. 尝试刷新页面重试

### 问题：更新服务器配置失败
**症状**: curl命令返回错误
**排查步骤**:
1. 检查网络连接
2. 验证管理员令牌
3. 检查JSON格式
4. 确认服务器状态

## 📊 发布历史记录模板

建议为每次发布创建记录文件：`文档/发布记录/v1.0.x发布记录.md`

```markdown
# v1.0.x 发布记录

## 基本信息
- **版本号**: v1.0.x
- **发布时间**: 2025-07-30
- **发布人**: 开发者姓名
- **版本类型**: minor/major/patch

## 发布内容
- 主要功能1
- 主要功能2
- Bug修复

## 发布步骤执行情况
- [x] 版本准备
- [x] Git操作
- [x] GitHub Release
- [x] 更新服务器配置

## 验证结果
- [x] 更新检查正常
- [x] 下载链接可用
- [x] 版本通知显示

## 遇到的问题
- 问题描述
- 解决方案

## 备注
- 其他重要信息
```

---

**文档版本**: v1.0.0
**最后更新**: 2025年7月30日
**维护者**: 呈尚策划开发团队
**重要性**: ⭐⭐⭐⭐⭐ 必须严格遵守

**⚠️ 再次强调**: 第4步"更新服务器配置"是最容易遗漏的步骤，每次发布都必须执行！
