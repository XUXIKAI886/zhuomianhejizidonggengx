# 登录系统开发计划

**版本:** 1.0
**日期:** 2025-07-31

## 1. 项目目标

在呈尚策划工具箱桌面应用中，完整实现一个安全、可靠的用户认证与管理系统。该系统需无缝集成于现有应用，并为未来的功能扩展提供支持。

## 2. 项目里程碑

| 里程碑 | 主要交付物 | 预计完成日期 |
| :--- | :--- | :--- |
| **M1: 规划与设计** | 产品需求、技术设计、开发计划、UI规范文档 | Day 1 |
| **M2: 核心后端完成** | 数据库集成、核心认证API、用户管理API | Day 3 |
| **M3: 核心前端完成** | 全局认证状态、登录页、路由保护 | Day 5 |
| **M4: 功能完整** | 后台管理页、主界面改造、统计功能实现 | Day 8 |
| **M5: 测试与交付** | 完成联调测试、修复主要Bug、代码审查、正式集成 | Day 10 |

## 3. 开发阶段与任务分解

### Phase 1: 环境搭建与后端核心 (预计 2 天)

- **T1.1: [后端] 引入依赖** (0.5 天)
  - 在 `Cargo.toml` 中添加 `mongodb`, `bcrypt`, `serde` (with derive feature) 等依赖。
  - 确保 Rust driver 版本与目标 MongoDB 服务兼容。

- **T1.2: [后端] 数据库连接与配置** (0.5 天)
  - 在 Rust 端实现一个单例或共享的 MongoDB 客户端。
  - 将数据库连接字符串 `mongodb://root:6scldk9f@dbconn.sealosbja.site:39056/?directConnection=true` 安全地配置在应用中（例如，通过环境变量或加密配置文件），而不是硬编码。
  - 实现应用启动时检查数据库连接的逻辑。

- **T1.3: [后端] 实现核心认证命令** (1 天)
  - 实现 `login`, `logout`, `check_session` 三个 Tauri command。
  - 集成 `bcrypt` 进行密码的加密存储和验证。

### Phase 2: 前端认证框架 (预计 2 天)

- **T2.1: [前端] 创建认证上下文 (AuthContext)** (1 天)
  - 创建 `AuthContext`，定义 `user`, `isAuthenticated`, `login`, `logout` 等状态和方法。
  - 使用 `React.Context` 和 `useReducer` 实现 `AuthProvider`。

- **T2.2: [前端] 实现登录页面 UI** (0.5 天)
  - 创建 `/login` 路由和页面组件。
  - 使用 `shadcn/ui` 组件库构建登录表单界面，包括输入框、复选框和按钮。

- **T2.3: [前端] 实现路由保护** (0.5 天)
  - 在根布局 `layout.tsx` 中集成 `AuthProvider`。
  - 创建一个高阶组件或在布局中实现逻辑，保护需要登录才能访问的页面。

### Phase 3: 功能实现 (预计 3 天)

- **T3.1: [前端] 对接登录接口** (0.5 天)
  - 在登录页面中，调用 `AuthContext` 的 `login` 方法，实现完整的登录流程和UI反馈。

- **T3.2: [后端] 实现用户管理 API** (1 天)
  - 实现 `get_all_users`, `create_user`, `update_user`, `reset_password`, `toggle_user_status`, `delete_user` 等所有管理员权限的 API。
  - **重点:** 确保每个 API 都进行了严格的管理员角色权限校验。

- **T3.3: [前端] 实现后台管理页面 UI** (1 天)
  - 创建 `/admin` 路由和页面组件。
  - 使用 `Table`, `Dialog`, `Button` 等 `shadcn/ui` 组件构建用户管理界面。

- **T3.4: [前端] 对接用户管理接口** (0.5 天)
  - 在后台管理页面实现对用户数据的增删改查功能。

### Phase 4: 界面改造与统计 (预计 1 天)

- **T4.1: [前端] 改造 Header 组件** (0.5 天)
  - 从 `AuthContext` 获取用户信息，动态显示用户名和头像。
  - 实现下拉菜单中的“退出登录”功能。

- **T4.2: [后端+前端] 实现使用统计追踪** (0.5 天)
  - **后端:** 实现 `track_tool_click` 和 `track_tool_usage` 命令。
  - **前端:** 在 `ToolGrid` 和 `WebViewModal` 组件中 `invoke` 相应的追踪命令。

### Phase 5: 测试、优化与文档 (预计 2 天)

- **T5.1: 联调测试** (1 天)
  - 全面测试所有功能点，包括正常流程和异常流程（如错误的密码、无权限访问等）。
  - 重点测试角色权限控制是否严密。

- **T5.2: Bug 修复与体验优化** (0.5 天)
  - 修复测试中发现的问题。
  - 优化加载状态、错误提示等用户体验细节。

- **T5.3: 代码审查与文档完善** (0.5 天)
  - 对新增代码进行 Code Review。
  - 确保所有代码注释和相关文档都是最新的。

## 4. 资源与风险

- **所需资源:**
  - 开发人员: 1-2 名，熟悉 Rust 和 React/Next.js。
  - 测试人员: 1 名，负责功能和安全测试。

- **潜在风险:**
  - **风险1:** Rust 与前端状态同步的复杂性。
    - **应对:** 充分利用 Tauri 的事件系统（Events）进行双向通信，处理好状态同步的边界情况。
  - **风险2:** 数据库版本迁移问题。
    - **应对:** 初期版本可不考虑迁移。未来若需修改表结构，需设计一套简单的迁移脚本。
  - **风险3:** 安全漏洞。
    - **应对:** 严格遵守安全设计规范，后端进行强制权限校验，对所有输入进行清理，进行专门的安全测试。
