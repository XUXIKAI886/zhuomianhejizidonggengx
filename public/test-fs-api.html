<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•Tauri FS API</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>ğŸ§ª Tauri FS API æµ‹è¯•å·¥å…·</h1>

    <div class="test-section">
        <h2>ç¯å¢ƒæ£€æµ‹</h2>
        <button onclick="checkEnvironment()">æ£€æµ‹Tauriç¯å¢ƒ</button>
        <pre id="env-result"></pre>
    </div>

    <div class="test-section">
        <h2>æµ‹è¯•1: ç›´æ¥å‚æ•°æ ¼å¼ (å½“å‰æ–‡æ¡£ä¸­çš„æ ¼å¼)</h2>
        <button onclick="testWriteDirectParams()">æµ‹è¯•å†™å…¥</button>
        <pre id="test1-result"></pre>
    </div>

    <div class="test-section">
        <h2>æµ‹è¯•2: OptionsåŒ…è£¹æ ¼å¼</h2>
        <button onclick="testWriteWithOptions()">æµ‹è¯•å†™å…¥</button>
        <pre id="test2-result"></pre>
    </div>

    <div class="test-section">
        <h2>æµ‹è¯•3: ä½¿ç”¨Tauri APIå¯¹è±¡ (éinvoke)</h2>
        <button onclick="testWriteWithAPI()">æµ‹è¯•å†™å…¥</button>
        <pre id="test3-result"></pre>
    </div>

    <div class="test-section">
        <h2>å®Œæ•´ä¸‹è½½æµç¨‹æµ‹è¯•</h2>
        <button onclick="testFullDownload()">æµ‹è¯•å®Œæ•´ä¸‹è½½æµç¨‹</button>
        <pre id="full-test-result"></pre>
    </div>

    <script>
        function checkEnvironment() {
            const result = document.getElementById('env-result');
            const checks = [];

            checks.push('window.__TAURI__: ' + (typeof window.__TAURI__ !== 'undefined' ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'));
            checks.push('window.__TAURI__.core: ' + (typeof window.__TAURI__?.core !== 'undefined' ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'));
            checks.push('window.__TAURI__.core.invoke: ' + (typeof window.__TAURI__?.core?.invoke !== 'undefined' ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'));
            checks.push('window.__TAURI__.fs: ' + (typeof window.__TAURI__?.fs !== 'undefined' ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'));

            result.textContent = checks.join('\n');
        }

        // æµ‹è¯•1: ç›´æ¥å‚æ•°æ ¼å¼
        async function testWriteDirectParams() {
            const result = document.getElementById('test1-result');
            result.textContent = 'æµ‹è¯•ä¸­...';

            try {
                console.log('ğŸ§ª [Test 1] ä½¿ç”¨ç›´æ¥å‚æ•°æ ¼å¼');

                // åˆ›å»ºæµ‹è¯•æ•°æ®
                const testData = [72, 101, 108, 108, 111, 32, 87, 111, 114, 108, 100]; // "Hello World"

                // æ–¹æ³•1: ç›´æ¥å‚æ•°
                await window.__TAURI__.core.invoke('plugin:fs|write_file', {
                    path: 'E:\\Desktop\\test-direct.txt',
                    contents: testData
                });

                result.innerHTML = '<span class="success">âœ… æˆåŠŸ!</span>\n\nå‚æ•°æ ¼å¼:\n' +
                    JSON.stringify({
                        path: 'E:\\Desktop\\test-direct.txt',
                        contents: testData
                    }, null, 2);

            } catch (error) {
                result.innerHTML = '<span class="error">âŒ å¤±è´¥!</span>\n\n' +
                    'é”™è¯¯: ' + error.message;
                console.error('Test 1 å¤±è´¥:', error);
            }
        }

        // æµ‹è¯•2: OptionsåŒ…è£¹æ ¼å¼
        async function testWriteWithOptions() {
            const result = document.getElementById('test2-result');
            result.textContent = 'æµ‹è¯•ä¸­...';

            try {
                console.log('ğŸ§ª [Test 2] ä½¿ç”¨optionsåŒ…è£¹æ ¼å¼');

                const testData = [72, 101, 108, 108, 111, 32, 87, 111, 114, 108, 100];

                // æ–¹æ³•2: optionsåŒ…è£¹
                await window.__TAURI__.core.invoke('plugin:fs|write_file', {
                    options: {
                        path: 'E:\\Desktop\\test-options.txt',
                        contents: testData
                    }
                });

                result.innerHTML = '<span class="success">âœ… æˆåŠŸ!</span>\n\nå‚æ•°æ ¼å¼:\n' +
                    JSON.stringify({
                        options: {
                            path: 'E:\\Desktop\\test-options.txt',
                            contents: testData
                        }
                    }, null, 2);

            } catch (error) {
                result.innerHTML = '<span class="error">âŒ å¤±è´¥!</span>\n\n' +
                    'é”™è¯¯: ' + error.message;
                console.error('Test 2 å¤±è´¥:', error);
            }
        }

        // æµ‹è¯•3: ä½¿ç”¨Tauri APIå¯¹è±¡
        async function testWriteWithAPI() {
            const result = document.getElementById('test3-result');
            result.textContent = 'æµ‹è¯•ä¸­...';

            try {
                console.log('ğŸ§ª [Test 3] ä½¿ç”¨Tauri fs APIå¯¹è±¡');

                const testData = new Uint8Array([72, 101, 108, 108, 111, 32, 87, 111, 114, 108, 100]);

                // æ–¹æ³•3: ä½¿ç”¨fs APIå¯¹è±¡ (å¦‚æœå­˜åœ¨)
                if (window.__TAURI__.fs && window.__TAURI__.fs.writeFile) {
                    await window.__TAURI__.fs.writeFile('E:\\Desktop\\test-api.txt', testData);
                    result.innerHTML = '<span class="success">âœ… æˆåŠŸ!</span>\n\nä½¿ç”¨: window.__TAURI__.fs.writeFile()';
                } else {
                    result.innerHTML = '<span class="error">âš ï¸ APIä¸å­˜åœ¨</span>\n\nwindow.__TAURI__.fs.writeFile ä¸å¯ç”¨';
                }

            } catch (error) {
                result.innerHTML = '<span class="error">âŒ å¤±è´¥!</span>\n\n' +
                    'é”™è¯¯: ' + error.message;
                console.error('Test 3 å¤±è´¥:', error);
            }
        }

        // å®Œæ•´ä¸‹è½½æµç¨‹æµ‹è¯•
        async function testFullDownload() {
            const result = document.getElementById('full-test-result');
            result.textContent = 'æµ‹è¯•ä¸­...';

            try {
                console.log('ğŸ§ª [Full Test] å®Œæ•´ä¸‹è½½æµç¨‹');

                // 1. åˆ›å»ºæµ‹è¯•å›¾ç‰‡ (å°çš„Base64å›¾ç‰‡)
                const canvas = document.createElement('canvas');
                canvas.width = 100;
                canvas.height = 100;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = 'red';
                ctx.fillRect(0, 0, 100, 100);
                ctx.fillStyle = 'white';
                ctx.font = '20px Arial';
                ctx.fillText('TEST', 20, 60);
                const dataUrl = canvas.toDataURL('image/png');

                console.log('ğŸ“¸ å›¾ç‰‡Data URLç”ŸæˆæˆåŠŸ, é•¿åº¦:', dataUrl.length);

                // 2. è°ƒç”¨ä¿å­˜å¯¹è¯æ¡†
                const filePath = await window.__TAURI__.core.invoke('plugin:dialog|save', {
                    options: {
                        defaultPath: 'test-image.png',
                        title: 'æµ‹è¯•ä¿å­˜å›¾ç‰‡',
                        filters: [{
                            name: 'å›¾ç‰‡æ–‡ä»¶',
                            extensions: ['png']
                        }]
                    }
                });

                if (!filePath) {
                    result.textContent = 'âš ï¸ ç”¨æˆ·å–æ¶ˆäº†ä¿å­˜';
                    return;
                }

                console.log('ğŸ“ é€‰æ‹©çš„è·¯å¾„:', filePath);

                // 3. è½¬æ¢Base64ä¸ºå­—èŠ‚æ•°ç»„
                const base64Data = dataUrl.split(',')[1];
                const binaryData = atob(base64Data);
                const bytes = new Uint8Array(binaryData.length);
                for (let i = 0; i < binaryData.length; i++) {
                    bytes[i] = binaryData.charCodeAt(i);
                }

                console.log('ğŸ’¾ å­—èŠ‚æ•°ç»„å‡†å¤‡å®Œæˆ, å¤§å°:', bytes.length, 'bytes');

                // 4. å°è¯•ä¸åŒçš„å†™å…¥æ–¹æ³•
                let writeSuccess = false;
                let successMethod = '';

                // å°è¯•æ–¹æ³•1: ç›´æ¥å‚æ•°
                try {
                    console.log('ğŸ“ å°è¯•æ–¹æ³•1: ç›´æ¥å‚æ•°');
                    await window.__TAURI__.core.invoke('plugin:fs|write_file', {
                        path: filePath,
                        contents: Array.from(bytes)
                    });
                    writeSuccess = true;
                    successMethod = 'æ–¹æ³•1: ç›´æ¥å‚æ•°æ ¼å¼';
                } catch (e1) {
                    console.log('âŒ æ–¹æ³•1å¤±è´¥:', e1.message);

                    // å°è¯•æ–¹æ³•2: optionsåŒ…è£¹
                    try {
                        console.log('ğŸ“ å°è¯•æ–¹æ³•2: optionsåŒ…è£¹');
                        await window.__TAURI__.core.invoke('plugin:fs|write_file', {
                            options: {
                                path: filePath,
                                contents: Array.from(bytes)
                            }
                        });
                        writeSuccess = true;
                        successMethod = 'æ–¹æ³•2: optionsåŒ…è£¹æ ¼å¼';
                    } catch (e2) {
                        console.log('âŒ æ–¹æ³•2å¤±è´¥:', e2.message);
                        throw new Error('æ‰€æœ‰å†™å…¥æ–¹æ³•éƒ½å¤±è´¥:\næ–¹æ³•1: ' + e1.message + '\næ–¹æ³•2: ' + e2.message);
                    }
                }

                if (writeSuccess) {
                    result.innerHTML = '<span class="success">âœ… å®Œæ•´ä¸‹è½½æµç¨‹æˆåŠŸ!</span>\n\n' +
                        'æˆåŠŸæ–¹æ³•: ' + successMethod + '\n' +
                        'ä¿å­˜è·¯å¾„: ' + filePath + '\n' +
                        'æ–‡ä»¶å¤§å°: ' + bytes.length + ' bytes';
                }

            } catch (error) {
                result.innerHTML = '<span class="error">âŒ å®Œæ•´æµç¨‹å¤±è´¥!</span>\n\n' +
                    'é”™è¯¯: ' + error.message;
                console.error('Full test å¤±è´¥:', error);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æµ‹ç¯å¢ƒ
        window.addEventListener('DOMContentLoaded', () => {
            checkEnvironment();
        });
    </script>
</body>
</html>
